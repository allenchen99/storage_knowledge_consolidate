# File Locks
# 文件锁机制对比表：NFSv3、NFSv4 与 SMB（含 Oplock）

| 特性                        | NFSv3                        | NFSv4                            | SMB（含 Oplocks）                        |
|-----------------------------|------------------------------|----------------------------------|-------------------------------------------|
| 锁实现方式                 | 依赖外部协议 NLM/NSM         | 协议内建支持                    | 协议内建支持（支持 Oplocks 机制）         |
| 协议状态性                 | 无状态（Stateless）          | 有状态（Stateful）              | 有状态（Stateful）                        |
| 锁类型                     | 建议锁（Advisory Lock）       | 建议锁、强制锁、委托锁等        | 建议锁、强制锁、Oplock（机会锁）          |
| 字节范围锁（Byte-range）   | 支持                         | 支持                             | 支持                                      |
| 文件委托（Delegation）     | 不支持                       | 支持（提高性能）                | 类似 Oplock 概念                          |
| 锁恢复机制                 | 依赖 NSM                     | 内建锁恢复和租约机制            | Oplock Break 通知机制                    |
| 租约机制（Lease）          | 不支持                       | 支持（客户端需续约）            | Oplock 需要客户端回应 Break               |
| 服务器重启后锁恢复         | 客户端通过 NSM 恢复           | 客户端自动 reclaim               | 客户端需要重新申请（Oplock 会失效）       |
| 冲突检测                   | 不支持（客户端自行判断）     | 支持（服务器统一检测）          | 支持（服务器控制）                        |
| 防火墙兼容性               | 差，依赖多个动态端口         | 好，单端口 2049                 | 好，使用 TCP 445 端口                     |
| 配置复杂度                 | 高（涉及多个服务）            | 适中                             | 适中，Oplock 可配置                        |
| 性能优化                   | 无特定优化                   | 有委托（Delegation）提升性能   | 有 Oplock 可显著减少 I/O 往返             |
| 多客户端访问一致性         | 易丢锁、易冲突               | 更强一致性                      | Oplock 需管理好才能一致                   |
| 推荐用途                   | 简单文件共享、兼容旧系统     | 多客户端读写、高并发应用        | 企业文件共享、Windows 环境、桌面场景      |

> 注：Oplock（Opportunistic Locking）是 SMB 协议特有的一种客户端缓存优化机制，与传统文件锁不同，主要目的是性能提升，但在高并发写场景（如数据库）中需谨慎使用。

