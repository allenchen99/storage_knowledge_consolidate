# 关于负载均衡的测试
## 负载均衡测试的要点
实际上负载均衡是什么的负载？对于现代计算机啊架构来说无非就是基于计算，网络，存储的均衡。所以测试的方向如下
1. 压测下是否能正确的进行负载均衡，所关注的相关设计指标能否正确的均衡
2. 新增/删除节点后，负载均衡能不能重新均衡。 关注的指标： 再平衡的速度，正常的IO是否能正常serve, latency有没有显著增高
3. 当有的节点实时繁忙，能否动态平衡， Latency是否正常

---

## 负载均衡测试相关的工具
| 工具 | 用途 | 
|------|------|
|stress-ng| CPU, IO压力测试|
|iperf|网络带宽，丢包模拟|
|fio,dd|IO的读写，空间的耗用|
|tnetem|Linux网络模拟器，限速，丢包，延迟|

## 压测的监控
结合python脚本进行压测，对相关指标用prometheus进行监控，定期获取节点数据，用Grafana进行展示


---


# 分布式存储系统节点繁忙度评分设计

本设计用于对分布式存储系统中每个存储节点的繁忙程度进行统一评分（0~1），以辅助调度、扩容、负载均衡和性能优化。
本设计方法并不只能，只是对指标参数进行简单的归一化，该算法提升有几个方向
1. 归一化+加权， 但是权重的确认需要基于经验来考虑并不是基于数据的判断
2. 动态权重+引擎规则
3. 机器学习+异常检测模型
5. 实时瓶颈诊断+预测下调度 

---

## 🧩 一、评估维度

本评分模型从以下 5 个主要维度评估每个节点的繁忙度：

| 类别 | 指标 | 说明 |
|------|------|------|
| 🧠 计算 | `cpu_usage_pct` | CPU 使用率 |
|        | `load_avg / cpu_cores` | 负载与核心数比值，更合理反映压力 |
| 🌐 网络 | `net_latency_ms` | 网络平均延迟 |
|        | `net_tx_rx_MBps` | 网络吞吐量（辅助参考） |
| 💽 存储IO | `io_latency_ms` | IO延迟，直接反映存储负载 |
|        | `iops_total` | 总IOPS（可辅助参考） |
| 🧱 磁盘使用 | `disk_util_pct` | 磁盘使用率（iostat %util） |
| 🧊 容量空间 | `disk_used_pct` | 已使用磁盘容量百分比 |
|        | `fs_inodes_used_pct` | inode 使用率（小文件密集场景） |

---

## 🧮 二、评分计算方法

### 1️⃣ 指标归一化函数

将原始指标转为 0~1 区间，代表资源使用强度：

```python
def normalize(value, min_val, max_val):
    return min(max((value - min_val) / (max_val - min_val), 0), 1)
```

### 2️⃣ 各项得分计算（示例）

```python
cpu_score = normalize(cpu_usage_pct, 0, 100)
load_score = normalize(load_avg / cpu_cores, 0, 2)
net_score = normalize(net_latency_ms, 1, 100)
io_score = normalize(io_latency_ms, 1, 50)
disk_util_score = normalize(disk_util_pct, 0, 100)
space_score = normalize(disk_used_pct, 60, 95)
```

### 3️⃣ 繁忙度总分公式（可调权重）

```python
busy_score = (
    0.20 * cpu_score +
    0.05 * load_score +
    0.15 * net_score +
    0.25 * io_score +
    0.15 * disk_util_score +
    0.20 * space_score
)
```

---

## 🟨 三、评分区间与状态分类

| 分数区间 | 等级 | 含义 | 操作建议 |
|----------|------|------|----------|
| 0.00 ~ 0.30 | 🟢 空闲 | 可分配任务 | 正常使用 |
| 0.31 ~ 0.60 | 🟡 正常 | 无瓶颈 | 保持稳定 |
| 0.61 ~ 0.80 | 🟠 偏忙 | 风险上升 | 限制新写入 |
| 0.81 ~ 1.00 | 🔴 繁忙 | 高风险节点 | 降权、迁移、扩容 |

---

## 📈 四、输出结构示例

```json
{
  "node": "node-1",
  "score": 0.76,
  "level": "busy",
  "metrics": {
    "cpu_usage_pct": 85.2,
    "load_avg": 6.4,
    "cpu_cores": 4,
    "net_latency_ms": 45,
    "io_latency_ms": 15,
    "disk_util_pct": 88,
    "disk_used_pct": 93.5
  }
}
```

---

## 📊 五、可视化与集成

- 可集成 Prometheus + Grafana 监控平台，按节点展示繁忙度评分曲线
- 可对接 Ceph、HDFS、MinIO 等系统作为副本调度/负载均衡依据
- 可用于自动扩容、智能告警、容量预警等系统

---

更新时间：{datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
